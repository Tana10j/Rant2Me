<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Therapy Chat — Tana</title>
  <link rel="stylesheet" href="chat-style.css" />
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">Chat with Tana (Therapist)</div>

    <div class="chat-messages" id="chat-box">
      <!-- initial bot line can remain; realtime listener will re-render if there are saved messages -->
      <div class="message bot">
        <img src="assets/avatars/Tana.png" class="avatar" />
        <div class="bubble">Hello — I'm Tana, a professional listener. How can I help?</div>
      </div>
    </div>

    <div class="chat-input">
      <input type="text" id="userInput" placeholder="Type your message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script type="module">
  import { auth, db } from './firebase.js';
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
  import {
    getFirestore, 
    collection,
    addDoc,
    serverTimestamp,
    query,
    orderBy,
    onSnapshot,
    doc,        // ⬅️ ADD THIS
    setDoc      // ⬅️ AND THIS
  } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

  const SECTION = "counselling";
  const ADMIN_NAME = "Tana";

  const chatBox = document.getElementById('chat-box');
  const input = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');

  let currentUid = null;
  let messagesColRef = null;
  let unsubscribeSnapshot = null;

  onAuthStateChanged(auth, user => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }
    currentUid = user.uid;
    initRealtimeListenerForUser(currentUid);
  });

  function initRealtimeListenerForUser(uid) {
    const chatDocId = `${SECTION}_${uid}`;
    messagesColRef = collection(db, "chats", chatDocId, "messages");
    const q = query(messagesColRef, orderBy("timestamp"));

    if (typeof unsubscribeSnapshot === "function") unsubscribeSnapshot();

    unsubscribeSnapshot = onSnapshot(q, snapshot => {
      chatBox.innerHTML = "";
      snapshot.forEach(doc => {
        const d = doc.data();
        renderMessageToUI(d);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    }, err => {
      console.error("Firestore listener error:", err);
    });
  }

  function renderMessageToUI(msg) {
    const el = document.createElement("div");
    el.className = "message " + (msg.senderType === "user" ? "user" : "bot");

    if (msg.senderType === "admin" || msg.senderType === "bot") {
      const avatarName = (msg.senderType === "admin" && msg.adminName) ? msg.adminName : ADMIN_NAME;
      el.innerHTML = `<img src="assets/avatars/${avatarName}.png" class="avatar" />
                      <div class="bubble">${escapeHtml(msg.text)}</div>`;
    } else {
      el.innerHTML = `<div class="bubble">${escapeHtml(msg.text)}</div>`;
    }
    chatBox.appendChild(el);
  }

  sendBtn.addEventListener("click", sendMessage);
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendMessage();
  });

  async function sendMessage() {
  const text = input.value.trim();
  if (!text || !currentUid || !messagesColRef) return;

  input.value = "";

  try {
    // Ensure chat doc exists
    const chatDocId = `${SECTION}_${currentUid}`;
    const chatDocRef = doc(db, "chats", chatDocId);
    await setDoc(chatDocRef, {
      section: SECTION,
      userId: currentUid,
      createdAt: serverTimestamp()
    }, { merge: true });

    // Add user message
    await addDoc(messagesColRef, {
      text,
      senderType: "user",
      senderId: currentUid,
      timestamp: serverTimestamp()
    });

  } catch (err) {
    console.error("Firestore write error:", err);
    alert("Failed to send message — check console for details.");
    return;
  }

    const botFlagKey = `botReplySent_${SECTION}_${currentUid}`;
    if (!localStorage.getItem(botFlagKey)) {
      localStorage.setItem(botFlagKey, "true");
      const botText = `${ADMIN_NAME}: Thanks for your message! I’ll get back to you shortly.`;
      renderMessageToUI({ text: botText, senderType: "bot" });
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        await addDoc(messagesColRef, {
          text: botText,
          senderType: "admin",
          senderId: "system",
          adminName: ADMIN_NAME,
          timestamp: serverTimestamp(),
          section: SECTION
        });
      } catch (err) {
        console.error("Firestore write error (bot reply):", err);
      }
    }
  }

  function escapeHtml(str) {
    if (!str) return "";
    return str.replace(/[&<>"]/g, tag => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;'
    }[tag]));
  }
</script>
</body>
</html>
