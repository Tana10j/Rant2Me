<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mood Logs | Rant2Me</title>
  <link rel="icon" type="image/png" href="images/Rant2Me Favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'r2m-blue': '#0d1b2a',
            'r2m-blue-600': '#1b263b',
            'r2m-aqua': '#00b4d8',
            'r2m-sky': '#0077b6',
            'r2m-gold': '#F5C542'
          },
          borderRadius: { 'r-lg': '14px' },
          boxShadow: {
            'r-lg': '0 18px 40px rgba(0,43,85,.18)',
            'r-md': '0 10px 24px rgba(0,43,85,.14)',
            'r-sm': '0 6px 14px rgba(0,43,85,.10)'
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; background: #f8fafc; }
    h1.brand { font-family: "Cinzel Decorative", serif; }
    .fade-in { animation: fadeIn .9s ease both; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(6px); } to { opacity:1; transform:none } }
  </style>
</head>
<body class="min-h-screen bg-slate-50">

  <!-- HEADER -->
  <header class="sticky top-0 z-50 bg-gradient-to-r from-r2m-blue to-r2m-blue-600 text-white shadow-r-lg">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="home.html" class="flex items-center gap-3">
        <img src="images/Rant2Me Favicon.png" alt="Rant2Me Logo" class="w-10 h-10 rounded" />
        <h1 class="brand text-2xl md:text-3xl">Rant<span class="text-r2m-aqua">2</span>Me</h1>
      </a>
      <button onclick="window.location.href='home.html'" class="px-4 py-2 bg-white text-r2m-blue rounded-r-lg shadow hover:bg-slate-100 transition">Home</button>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-7xl mx-auto px-4 py-10 fade-in">

    <!-- HERO -->
    <section class="mb-8">
      <h2 class="text-3xl md:text-4xl font-extrabold text-r2m-blue mb-2">Mood Tracker Dashboard</h2>
      <p class="text-slate-600 max-w-xl">View the mood logs of your users. Use the search to filter by email or mood emoji. Only admins can access this page.</p>
    </section>

    <!-- STATS CARDS -->
    <section class="grid gap-6 md:grid-cols-4 mb-8">
      <div class="bg-white p-6 rounded-r-lg shadow-r-sm text-center hover:scale-[1.02] transition">
        <h3 class="text-lg font-semibold text-r2m-sky">Total Logs</h3>
        <p id="totalLogs" class="text-2xl font-bold mt-2">0</p>
      </div>
      <div class="bg-white p-6 rounded-r-lg shadow-r-sm text-center hover:scale-[1.02] transition">
        <h3 class="text-lg font-semibold text-r2m-sky">ğŸ˜Š Good</h3>
        <p id="goodCount" class="text-2xl font-bold mt-2">0</p>
      </div>
      <div class="bg-white p-6 rounded-r-lg shadow-r-sm text-center hover:scale-[1.02] transition">
        <h3 class="text-lg font-semibold text-r2m-sky">ğŸ˜ Okay</h3>
        <p id="okayCount" class="text-2xl font-bold mt-2">0</p>
      </div>
      <div class="bg-white p-6 rounded-r-lg shadow-r-sm text-center hover:scale-[1.02] transition">
        <h3 class="text-lg font-semibold text-r2m-sky">ğŸ˜” Bad</h3>
        <p id="badCount" class="text-2xl font-bold mt-2">0</p>
      </div>
    </section>

    <!-- FILTER AND EXPORT -->
    <section class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-4">
      <input id="searchInput" type="text" placeholder="Search by email or mood..." class="flex-1 px-4 py-2 rounded-r-lg shadow border border-slate-200 focus:outline-none focus:ring-2 focus:ring-r2m-aqua" />
      <button id="exportBtn" class="px-5 py-2 bg-r2m-aqua text-white rounded-r-lg shadow hover:bg-r2m-sky transition">Export CSV</button>
    </section>

    <!-- TABLE -->
    <section class="overflow-x-auto rounded-r-lg shadow-r-sm">
      <table class="min-w-full bg-white rounded-r-lg">
        <thead class="bg-r2m-blue text-white">
          <tr>
            <th class="px-4 py-3 text-left">User Email</th>
            <th class="px-4 py-3 text-left">Mood</th>
            <th class="px-4 py-3 text-left">Timestamp</th>
          </tr>
        </thead>
        <tbody id="moodTable" class="divide-y divide-slate-100"></tbody>
      </table>
    </section>

    <!-- NO ACCESS MESSAGE -->
    <div id="noAccessMsg" class="hidden text-center py-16 text-red-600 text-xl font-semibold"></div>

  </main>

  <!-- FOOTER -->
  <footer class="text-center py-6 text-sm text-slate-500">
    &copy; 2025 Rant2Me â€¢ <a href="about.html" class="text-r2m-aqua">About</a> â€¢ <a href="help.html" class="text-r2m-aqua">Support</a>
  </footer>

  <!-- ANALYTICS SECTION -->
<section class="my-10 grid grid-cols-1 md:grid-cols-2 gap-8">
  <!-- Mood Trend Line Chart -->
  <div class="bg-white p-6 rounded-r-lg shadow-r-sm fade-in">
    <h3 class="text-xl font-semibold text-r2m-blue mb-4">Mood Trend Over Time</h3>
    <canvas id="moodTrendChart" class="w-full h-64"></canvas>
  </div>

  <!-- Mood Distribution Pie Chart -->
  <div class="bg-white p-6 rounded-r-lg shadow-r-sm fade-in">
    <h3 class="text-xl font-semibold text-r2m-blue mb-4">Mood Distribution</h3>
    <canvas id="moodPieChart" class="w-full h-64"></canvas>
  </div>
</section>

<!-- SCRIPT -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAEVKUuUn0rypPGTzJ2UsVIy9HGYUBHLhI",
    authDomain: "rant2me-ab36b.firebaseapp.com",
    projectId: "rant2me-ab36b",
    storageBucket: "rant2me-ab36b.appspot.com",
    messagingSenderId: "245661393279",
    appId: "1:245661393279:web:b31483f57a40cf2c807a4a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const adminEmails = [
    "tana10j@gmail.com",
    "edukdorcas@gmail.com",
    "chideraumezurike13@gmail.com"
  ];

  async function loadMoods() {
    const snapshot = await getDocs(query(collection(db, "moods"), orderBy("createdAt")));
    const table = document.getElementById("moodTable");
    table.innerHTML = '';

    let total = 0, good = 0, okay = 0, bad = 0;
    let trendLabels = [], trendData = [], moodDistribution = { "ğŸ˜Š": 0, "ğŸ˜": 0, "ğŸ˜”": 0 };

    snapshot.forEach(doc => {
      const data = doc.data();
      total++;
      if(data.mood==="ğŸ˜Š") { good++; moodDistribution["ğŸ˜Š"]++; }
      else if(data.mood==="ğŸ˜") { okay++; moodDistribution["ğŸ˜"]++; }
      else if(data.mood==="ğŸ˜”") { bad++; moodDistribution["ğŸ˜”"]++; }

      trendLabels.push(formatDate(data.createdAt));
      trendData.push(data.mood === "ğŸ˜Š" ? 3 : data.mood === "ğŸ˜" ? 2 : 1); // Scale for trend

      const row = document.createElement('tr');
      row.classList.add('hover:bg-slate-50', 'transition');
      row.innerHTML = `
        <td class="px-4 py-2">${data.userEmail}</td>
        <td class="px-4 py-2 text-center">${data.mood}</td>
        <td class="px-4 py-2">${formatDate(data.createdAt)}</td>
      `;
      table.appendChild(row);
    });

    document.getElementById("totalLogs").textContent = total;
    document.getElementById("goodCount").textContent = good;
    document.getElementById("okayCount").textContent = okay;
    document.getElementById("badCount").textContent = bad;

    // Initialize Charts
    const trendCtx = document.getElementById('moodTrendChart').getContext('2d');
    new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: trendLabels,
        datasets: [{
          label: 'Mood Trend (3=Good, 2=Okay, 1=Bad)',
          data: trendData,
          borderColor: '#00b4d8',
          backgroundColor: 'rgba(0,180,216,0.1)',
          fill: true,
          tension: 0.3,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { min: 0, max: 3, ticks: { stepSize: 1, callback: v => v==3?'ğŸ˜Š':v==2?'ğŸ˜':'ğŸ˜”' } }
        }
      }
    });

    const pieCtx = document.getElementById('moodPieChart').getContext('2d');
    new Chart(pieCtx, {
      type: 'doughnut',
      data: {
        labels: ["ğŸ˜Š Good","ğŸ˜ Okay","ğŸ˜” Bad"],
        datasets: [{
          data: [moodDistribution["ğŸ˜Š"], moodDistribution["ğŸ˜"], moodDistribution["ğŸ˜”"]],
          backgroundColor: ['#00b4d8','#0077b6','#ff595e']
        }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  }

  function formatDate(timestamp){ return timestamp?.toDate().toLocaleString() || ''; }
  document.getElementById('searchInput').addEventListener('keyup', filterTable);
  document.getElementById('exportBtn').addEventListener('click', exportCSV);

  function filterTable() {
    const filter = document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('#moodTable tr').forEach(row => {
      const match = Array.from(row.cells).some(td => td.textContent.toLowerCase().includes(filter));
      row.style.display = match ? '' : 'none';
    });
  }

  function exportCSV() {
    let csv = "User Email,Mood,Timestamp\n";
    document.querySelectorAll('#moodTable tr').forEach(row => {
      const cols = Array.from(row.cells).map(td => td.textContent.replace(/,/g, ""));
      csv += cols.join(",") + "\n";
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `mood_logs_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
  }

  onAuthStateChanged(auth, user => {
    const noAccess = document.getElementById('noAccessMsg');
    const content = document.querySelector('main');
    if(user && adminEmails.includes(user.email)){
      loadMoods();
      content.classList.remove('hidden');
      noAccess.classList.add('hidden');
    } else {
      content.classList.add('hidden');
      noAccess.textContent = "Access Denied. You do not have permission to view this page.";
      noAccess.classList.remove('hidden');
    }
  });
</script>
</body>
</html>
